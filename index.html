<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Leads de Energía</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 2em; background-color: #f4f4f9; color: #333; }
        h1, h2 { color: #1d3557; }
        #app-container { max-width: 1200px; margin: auto; }
        #leads-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5em; margin-top: 2em;}
        .lead-card { background-color: white; border: 1px solid #ddd; border-radius: 8px; padding: 1em; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.2s; cursor: pointer; }
        .lead-card:hover { transform: translateY(-5px); }
        .lead-card h2 { margin-top: 0; color: #457b9d; }
        .lead-card p { margin: 0.5em 0; line-height: 1.6; }
        .lead-card a { color: #0056b3; text-decoration: none; }
        .lead-card a:hover { text-decoration: underline; }
        .lead-card strong { color: #1d3557; }
        input[type="text"], input[type="tel"], select { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 1em; }
        input:invalid { border-color: #e63946; }
        button { background-color: #2a9d8f; color: white; padding: 12px 18px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1em; transition: background-color 0.2s; }
        button:hover { background-color: #268c7f; }
        .edit-btn { background-color: #fca311; margin-top: 15px; }
        .delete-btn { background-color: #e63946; margin-top: 10px; }
        #add-lead-form { cursor: default; }
        #add-lead-form:hover { transform: none; }

        /* Estilos para Modales */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 10px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-btn { color: #aaa; position: absolute; top: 10px; right: 25px; font-size: 35px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: black; }
    </style>
</head>
<body>
    <div id="app-container">
        <h1>Gestor de Leads de Energía</h1>
        <form id="add-lead-form" class="lead-card">
            <h2>Agregar Nuevo Lead</h2>
            <p><input type="text" id="businessName" placeholder="Nombre del Negocio (obligatorio)" required minlength="3"></p>
            <p><input type="text" id="dmFirstName" placeholder="Nombre del Contacto"></p>
            <p><input type="text" id="dmLastName" placeholder="Apellido del Contacto"></p>
            <p><input type="tel" id="dmPhone" placeholder="Teléfono (solo números y símbolos)" pattern="[0-9-() +]+"></p>
            <p><input type="text" id="fullAddress" placeholder="Dirección Completa"></p>
            <button type="submit">Guardar Lead</button>
        </form>
        <div id="status"><p>Cargando leads...</p></div>
        <div id="leads-container"></div>
    </div>

    <div id="view-lead-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-view-modal-btn">×</span>
            <div id="lead-details-content"></div>
        </div>
    </div>
    
    <div id="edit-lead-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-edit-modal-btn">×</span>
            <form id="edit-lead-form">
                <h2>Editar Lead</h2>
                <input type="hidden" id="edit-lead-id">
                <p><strong>Nombre del Negocio:</strong><input type="text" id="edit-businessName" required minlength="3"></p>
                <p><strong>Nombre Contacto:</strong><input type="text" id="edit-dmFirstName"></p>
                <p><strong>Apellido Contacto:</strong><input type="text" id="edit-dmLastName"></p>
                <p><strong>Teléfono:</strong><input type="tel" id="edit-dmPhone" pattern="[0-9-() +]+"></p>
                <p><strong>Dirección:</strong><input type="text" id="edit-fullAddress"></p>
                <p><strong>Progreso:</strong>
                    <select id="edit-leadProgress">
                        <option value="Nuevo">Nuevo</option>
                        <option value="CONTACTED">CONTACTED</option>
                        <option value="QUALIFIED">QUALIFIED</option>
                        <option value="QUOTED">QUOTED</option>
                        <option value="CONNECTED">CONNECTED</option>
                        <option value="LOST">LOST</option>
                    </select>
                </p>
                <button type="submit">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getFirestore, collection, getDocs, addDoc, serverTimestamp, doc, deleteDoc, query, orderBy, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAmZZPvjlfFBJYGccwpwpzvzdydmd7skFo",
        authDomain: "energy-broker-leads-manager.firebaseapp.com",
        projectId: "energy-broker-leads-manager",
        storageBucket: "energy-broker-leads-manager.appspot.com",
        messagingSenderId: "1016824630391",
        appId: "1:1016824630391:web:4705d1dfde6bfee9bfca72",
        measurementId: "G-BN2684HFCC"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const leadsCollection = collection(db, "leads");
      
      const addLeadForm = document.getElementById('add-lead-form');
      const leadsContainer = document.getElementById('leads-container');
      
      const viewModal = document.getElementById('view-lead-modal');
      const closeModalBtn = document.getElementById('close-view-modal-btn');
      const leadDetailsContent = document.getElementById('lead-details-content');
      
      const editModal = document.getElementById('edit-lead-modal');
      const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
      const editLeadForm = document.getElementById('edit-lead-form');

      // --- LÓGICA PARA GUARDAR NUEVO LEAD ---
      addLeadForm.addEventListener('submit', async (e) => { /* ...código sin cambios... */ });
      
      // --- LÓGICA PARA CLICS EN LA LISTA ---
      leadsContainer.addEventListener('click', async (e) => { /* ...código sin cambios... */ });
      
      // --- LÓGICA DE MODALES (VER Y CERRAR) ---
      closeModalBtn.onclick = () => viewModal.style.display = 'none';
      closeEditModalBtn.onclick = () => editModal.style.display = 'none';
      window.onclick = (event) => {
          if (event.target == viewModal) viewModal.style.display = 'none';
          if (event.target == editModal) editModal.style.display = 'none';
      };

      async function mostrarDetalleLead(leadId) {
          try {
              const docRef = doc(db, "leads", leadId);
              const docSnap = await getDoc(docRef);
              if (docSnap.exists()) {
                  const lead = docSnap.data();
                  leadDetailsContent.innerHTML = `
                      <h2>${lead.businessName}</h2>
                      <p><strong>Contacto:</strong> ${lead.dm.firstName} ${lead.dm.lastName}</p>
                      <p><strong>Teléfono:</strong> ${lead.dm.phone}</p>
                      <p><strong>Dirección:</strong> ${lead.address.fullAddress || 'N/A'}</p>
                      <p><strong>Progreso:</strong> ${lead.leadProgress}</p>
                      <p><strong>Fecha:</strong> ${lead.createdAt ? new Date(lead.createdAt.seconds * 1000).toLocaleString() : 'N/A'}</p>
                      <button class="edit-btn" data-id="${leadId}">Editar Lead</button>
                  `;
                  viewModal.style.display = 'flex';
              }
          } catch (error) { console.error("Error al mostrar detalle:", error); }
      }

      // --- LÓGICA DE EDICIÓN ---
      leadDetailsContent.addEventListener('click', (e) => {
          if (e.target.classList.contains('edit-btn')) {
              const leadId = e.target.dataset.id;
              abrirModalEdicion(leadId);
          }
      });

      async function abrirModalEdicion(leadId) {
          try {
              const docRef = doc(db, "leads", leadId);
              const docSnap = await getDoc(docRef);
              if (docSnap.exists()) {
                  const lead = docSnap.data();
                  // Llenamos el formulario de edición con los datos actuales
                  editLeadForm['edit-lead-id'].value = leadId;
                  editLeadForm['edit-businessName'].value = lead.businessName;
                  editLeadForm['edit-dmFirstName'].value = lead.dm.firstName;
                  editLeadForm['edit-dmLastName'].value = lead.dm.lastName;
                  editLeadForm['edit-dmPhone'].value = lead.dm.phone;
                  editLeadForm['edit-fullAddress'].value = lead.address.fullAddress;
                  editLeadForm['edit-leadProgress'].value = lead.leadProgress;
                  
                  viewModal.style.display = 'none'; // Cerramos el modal de vista
                  editModal.style.display = 'flex'; // Abrimos el modal de edición
              }
          } catch (error) { console.error("Error al abrir edición:", error); }
      }

      editLeadForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const leadId = editLeadForm['edit-lead-id'].value;
          const docRef = doc(db, "leads", leadId);
          
          try {
              await updateDoc(docRef, {
                  businessName: editLeadForm['edit-businessName'].value,
                  dm: {
                      firstName: editLeadForm['edit-dmFirstName'].value,
                      lastName: editLeadForm['edit-dmLastName'].value,
                      phone: editLeadForm['edit-dmPhone'].value
                  },
                  address: {
                      fullAddress: editLeadForm['edit-fullAddress'].value
                  },
                  leadProgress: editLeadForm['edit-leadProgress'].value
              });
              editModal.style.display = 'none';
              await CargarLeads();
          } catch (error) {
              console.error("Error al actualizar:", error);
              alert("Hubo un error al guardar los cambios.");
          }
      });
      
      // --- FUNCIÓN PRINCIPAL PARA CARGAR LEADS ---
      async function CargarLeads() { /* ...código sin cambios... */ }
      
      // --- REEMPLAZO DE CÓDIGO FALTANTE PARA CLARIDAD ---
      // (Este es el código que se marcó como "sin cambios" para que el archivo sea completo)
      addLeadForm.addEventListener('submit', async (e) => { e.preventDefault(); const btn = e.target.querySelector('button'); btn.disabled = true; btn.textContent = 'Guardando...'; try { await addDoc(leadsCollection, { businessName: addLeadForm.businessName.value, dm: { firstName: addLeadForm.dmFirstName.value, lastName: addLeadForm.dmLastName.value, phone: addLeadForm.dmPhone.value, email: "" }, address: { fullAddress: addLeadForm.fullAddress.value }, leadProgress: "Nuevo", createdAt: serverTimestamp() }); addLeadForm.reset(); await CargarLeads(); } catch (error) { console.error("E: ", error); } finally { btn.disabled = false; btn.textContent = 'Guardar Lead'; } });
      leadsContainer.addEventListener('click', async (e) => { const card = e.target.closest('.lead-card'); if (!card) return; if (e.target.classList.contains('delete-btn')) { e.stopPropagation(); const id = e.target.dataset.id; if (confirm("¿Seguro?")) { try { await deleteDoc(doc(db, "leads", id)); await CargarLeads(); } catch (error) { console.error("E: ", error); } } } else { const id = card.id; mostrarDetalleLead(id); } });
      async function CargarLeads() { const statusDiv = document.getElementById('status'); try { const q = query(leadsCollection, orderBy("createdAt", "desc")); const querySnapshot = await getDocs(q); leadsContainer.innerHTML = ''; if (querySnapshot.empty) { statusDiv.innerHTML = '<p>No hay leads.</p>'; statusDiv.style.display = 'block'; return; } querySnapshot.forEach((doc) => { const lead = doc.data(); let addressHTML = ''; if (lead.address && lead.address.fullAddress) { const encodedAddress = encodeURIComponent(lead.address.fullAddress); const mapsUrl = `https://www.google.com/maps/search/?api=1&query=LA_DIRECCION_AQUI9{encodedAddress}`; addressHTML = `<p><strong>Dirección:</strong> <a href="${mapsUrl}" target="_blank">${lead.address.fullAddress}</a></p>`; } const cardHTML = `<div class="lead-card" id="${doc.id}"><h2>${lead.businessName||'N/A'}</h2><p><strong>Contacto:</strong> ${lead.dm.firstName||''} ${lead.dm.lastName||''}</p><p><strong>Teléfono:</strong> ${lead.dm.phone||'N/A'}</p>${addressHTML}<p><strong>Progreso:</strong> ${lead.leadProgress||'N/A'}</p><button class="delete-btn" data-id="${doc.id}">Eliminar</button></div>`; leadsContainer.innerHTML += cardHTML; }); statusDiv.style.display = 'none'; } catch (error) { console.error("E: ", error); statusDiv.innerHTML = '<p style="color:red;">Error al cargar.</p>'; statusDiv.style.display = 'block'; } }

      CargarLeads();
    </script>
</body>
</html>
