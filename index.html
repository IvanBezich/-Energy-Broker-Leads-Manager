<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Broker Leads Manager</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f9; }
        .hidden { display: none; }
        #view-switcher { margin-bottom: 1em; }
        #view-switcher button { background-color: #6c757d; }
        #view-switcher button.active { background-color: #007bff; }
        
        /* Estilos de Tarjetas */
        #card-view-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5em; margin-top: 2em;}
        .lead-card { background-color: white; border: 1px solid #ddd; border-radius: 8px; padding: 1.5em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1.5em;}
        
        /* Estilos de Lista */
        #list-view-container { width: 100%; overflow-x: auto; margin-top: 2em; }
        .leads-table { width: 100%; border-collapse: collapse; background-color: white; }
        .leads-table th, .leads-table td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; }
        .leads-table th { background-color: #e9ecef; cursor: pointer; }
        .leads-table th:hover { background-color: #d1d9e0; }
        .leads-table tbody tr:nth-of-type(even) { background-color: #f8f9fa; }

        /* Estilos compartidos y de formato condicional */
        input, textarea, select { width: 95%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white;}
        button[type="submit"] { background-color: #28a745; }
        .delete-btn { background-color: #dc3545; }
        .edit-btn { background-color: #007bff; margin-right: 5px;}
        .status-tag { padding: 4px 8px; border-radius: 12px; color: white; font-size: 12px; font-weight: bold; }
        .progress-untouched { background-color: #007bff; }
        .progress-engaged, .progress-qualified { background-color: #add8e6; color: #333; }
        .progress-quoted { background-color: #90ee90; color: #333; }
        .progress-lost { background-color: #dc3545; }
        .progress-signed, .progress-energized { background-color: #28a745; }
        .meter-no-meter, .meter-off { background-color: #dc3545; }
        .meter-temp { background-color: #90ee90; color: #333; }
        .meter-energized { background-color: #218838; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div id="lang-switcher">...</div>
    <h1 data-key="appTitle">Gestor de Leads</h1>

    <div id="view-switcher">
        <button id="card-view-btn" class="active" data-key="cardView">Vista Tarjetas</button>
        <button id="list-view-btn" data-key="listView">Vista Lista</button>
    </div>

    <form id="add-lead-form" class="lead-card">...</form>

    <div id="status"><p data-key="loadingLeads">Cargando leads...</p></div>

    <div id="card-view-container"></div>
    <div id="list-view-container" class="hidden">
        <table class="leads-table">
            <thead>
                <tr>
                    <th data-sort-by="businessName" data-key="businessNameHeader">Nombre Negocio</th>
                    <th data-sort-by="createdAt" data-key="dateHeader">Fecha de Entrada</th>
                    <th data-sort-by="leadProgress" data-key="progressHeader">Progreso</th>
                    <th data-key="contactHeader">Contacto</th>
                    <th data-key="phoneHeader">Teléfono</th>
                    <th data-key="actionsHeader">Acciones</th>
                </tr>
            </thead>
            <tbody id="list-view-tbody"></tbody>
        </table>
    </div>

    <div id="edit-modal" class="modal">...</div>

   <script type="module">
      // 1. IMPORTACIONES: Traemos las herramientas que necesitamos de Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getFirestore, collection, getDocs, addDoc, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // 2. CONFIGURACIÓN: Tu llave secreta para conectar a tu proyecto
      const firebaseConfig = {
        apiKey: "AIzaSyAmZZPvjlfFBJYGccwpwpzvzdydmd7skFo",
        authDomain: "energy-broker-leads-manager.firebaseapp.com",
        projectId: "energy-broker-leads-manager",
        storageBucket: "energy-broker-leads-manager.appspot.com",
        messagingSenderId: "1016824630391",
        appId: "1:1016824630391:web:4705d1dfde6bfee9bfca72",
        measurementId: "G-BN2684HFCC"
      };

      // 3. INICIALIZACIÓN: Conectamos a Firebase y a la base de datos
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const leadsCollection = collection(db, "leads");

      // --- CÓDIGO PARA GUARDAR EL FORMULARIO ---
      const addLeadForm = document.getElementById('add-lead-form');
      addLeadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const businessName = addLeadForm.businessName.value;
        const dmFirstName = addLeadForm.dmFirstName.value;
        const dmLastName = addLeadForm.dmLastName.value;
        const dmPhone = addLeadForm.dmPhone.value;
        try {
            await addDoc(leadsCollection, {
                businessName: businessName,
                dm: { firstName: dmFirstName, lastName: dmLastName, phone: dmPhone, email: "" },
                leadProgress: "Nuevo",
                createdAt: serverTimestamp()
            });
            addLeadForm.reset();
            CargarLeads();
        } catch (error) {
            console.error("Error al guardar el lead: ", error);
            alert("Hubo un error al guardar el lead.");
        }
      });

      // --- CÓDIGO PARA MANEJAR LOS CLICS DE ELIMINAR ---
      const leadsContainer = document.getElementById('leads-container');
      leadsContainer.addEventListener('click', async (e) => {
          if (e.target.classList.contains('delete-btn')) {
              const leadId = e.target.dataset.id;
              if (confirm("¿Estás seguro de que querés eliminar este lead?")) {
                  try {
                      const docRef = doc(db, "leads", leadId);
                      await deleteDoc(docRef);
                      CargarLeads();
                  } catch (error) {
                      console.error("Error al eliminar el lead: ", error);
                      alert("Hubo un error al eliminar el lead.");
                  }
              }
          }
      });

      // --- Función para Cargar Leads ---
      async function CargarLeads() {
        const statusDiv = document.getElementById('status');
        try {
            const querySnapshot = await getDocs(leadsCollection);
            leadsContainer.innerHTML = '';
            if (querySnapshot.empty) {
                statusDiv.innerHTML = '<p>No se encontraron leads.</p>';
                return;
            }
            querySnapshot.forEach((doc) => {
                const lead = doc.data();
                const leadCardHTML = `
                    <div class="lead-card">
                        <h2>${lead.businessName || 'Sin Nombre'}</h2>
                        <p><strong>Contacto:</strong> ${lead.dm.firstName || ''} ${lead.dm.lastName || ''}</p>
                        <p><strong>Teléfono:</strong> ${lead.dm.phone || 'N/A'}</p>
                        <p><strong>Progreso:</strong> ${lead.leadProgress || 'N/A'}</p>
                        <button class="delete-btn" data-id="${doc.id}">Eliminar</button>
                    </div>
                `;
                leadsContainer.innerHTML += leadCardHTML;
            });
            statusDiv.style.display = 'none';
        } catch (error) {
            console.error("Error al cargar los leads: ", error);
            statusDiv.innerHTML = '<p>Hubo un error al conectar con la base de datos.</p>';
        }
      }

      // --- Ejecución inicial ---
      CargarLeads();
    </script>
