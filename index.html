<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Broker Leads Manager</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f9; }
        .hidden { display: none; }
        #view-switcher { margin-bottom: 1em; }
        #view-switcher button { background-color: #6c757d; }
        #view-switcher button.active { background-color: #007bff; }
        
        /* Estilos de Tarjetas */
        #card-view-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5em; margin-top: 2em;}
        .lead-card { background-color: white; border: 1px solid #ddd; border-radius: 8px; padding: 1.5em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1.5em;}
        
        /* Estilos de Lista */
        #list-view-container { width: 100%; overflow-x: auto; margin-top: 2em; }
        .leads-table { width: 100%; border-collapse: collapse; background-color: white; }
        .leads-table th, .leads-table td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; }
        .leads-table th { background-color: #e9ecef; cursor: pointer; }
        .leads-table th:hover { background-color: #d1d9e0; }
        .leads-table tbody tr:nth-of-type(even) { background-color: #f8f9fa; }

        /* Estilos compartidos y de formato condicional */
        input, textarea, select { width: 95%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white;}
        button[type="submit"] { background-color: #28a745; }
        .delete-btn { background-color: #dc3545; }
        .edit-btn { background-color: #007bff; margin-right: 5px;}
        .status-tag { padding: 4px 8px; border-radius: 12px; color: white; font-size: 12px; font-weight: bold; }
        .progress-untouched { background-color: #007bff; }
        .progress-engaged, .progress-qualified { background-color: #add8e6; color: #333; }
        .progress-quoted { background-color: #90ee90; color: #333; }
        .progress-lost { background-color: #dc3545; }
        .progress-signed, .progress-energized { background-color: #28a745; }
        .meter-no-meter, .meter-off { background-color: #dc3545; }
        .meter-temp { background-color: #90ee90; color: #333; }
        .meter-energized { background-color: #218838; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div id="lang-switcher">...</div>
    <h1 data-key="appTitle">Gestor de Leads</h1>

    <div id="view-switcher">
        <button id="card-view-btn" class="active" data-key="cardView">Vista Tarjetas</button>
        <button id="list-view-btn" data-key="listView">Vista Lista</button>
    </div>

    <form id="add-lead-form" class="lead-card">...</form>

    <div id="status"><p data-key="loadingLeads">Cargando leads...</p></div>

    <div id="card-view-container"></div>
    <div id="list-view-container" class="hidden">
        <table class="leads-table">
            <thead>
                <tr>
                    <th data-sort-by="businessName" data-key="businessNameHeader">Nombre Negocio</th>
                    <th data-sort-by="createdAt" data-key="dateHeader">Fecha de Entrada</th>
                    <th data-sort-by="leadProgress" data-key="progressHeader">Progreso</th>
                    <th data-key="contactHeader">Contacto</th>
                    <th data-key="phoneHeader">Teléfono</th>
                    <th data-key="actionsHeader">Acciones</th>
                </tr>
            </thead>
            <tbody id="list-view-tbody"></tbody>
        </table>
    </div>

    <div id="edit-modal" class="modal">...</div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getFirestore, collection, getDocs, addDoc, serverTimestamp, doc, deleteDoc, getDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // --- Diccionarios de Traducciones (actualizados) ---
      const translations = {
          es: {
              cardView: "Vista Tarjetas", listView: "Vista Lista", businessNameHeader: "Nombre Negocio", 
              dateHeader: "Fecha de Entrada", progressHeader: "Progreso", contactHeader: "Contacto",
              phoneHeader: "Teléfono", actionsHeader: "Acciones", /* ... otros textos ... */
          },
          en: {
              cardView: "Card View", listView: "List View", businessNameHeader: "Business Name",
              dateHeader: "Entry Date", progressHeader: "Progress", contactHeader: "Contact",
              phoneHeader: "Phone", actionsHeader: "Actions", /* ... other texts ... */
          }
      };
      
      const firebaseConfig = { /* ... tu config ... */ };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const leadsCollection = collection(db, "leads");

      // --- MANEJO DE VISTAS Y ORDENAMIENTO ---
      let currentView = 'card';
      let loadedLeads = []; // Guardamos los leads aquí para ordenarlos sin volver a llamar a Firebase
      let currentSort = { key: 'createdAt', direction: 'desc' };
      
      const cardViewBtn = document.getElementById('card-view-btn');
      const listViewBtn = document.getElementById('list-view-btn');
      const cardViewContainer = document.getElementById('card-view-container');
      const listViewContainer = document.getElementById('list-view-container');
      const listViewTbody = document.getElementById('list-view-tbody');
      
      cardViewBtn.addEventListener('click', () => switchView('card'));
      listViewBtn.addEventListener('click', () => switchView('list'));

      function switchView(view) {
          currentView = view;
          cardViewBtn.classList.toggle('active', view === 'card');
          listViewBtn.classList.toggle('active', view === 'list');
          cardViewContainer.classList.toggle('hidden', view !== 'card');
          listViewContainer.classList.toggle('hidden', view !== 'list');
      }

      document.querySelector('.leads-table thead').addEventListener('click', (e) => {
          if (e.target.tagName === 'TH') {
              const sortKey = e.target.dataset.sortBy;
              if (!sortKey) return;
              
              const direction = (currentSort.key === sortKey && currentSort.direction === 'asc') ? 'desc' : 'asc';
              currentSort = { key: sortKey, direction: direction };
              
              sortLeads();
              RenderLeads();
          }
      });

      function sortLeads() {
          loadedLeads.sort((a, b) => {
              const valA = a[currentSort.key] || '';
              const valB = b[currentSort.key] || '';
              
              if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
              if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
              return 0;
          });
      }
      
      // --- LÓGICA DE DATOS ---
      async function CargarLeads() {
          const statusDiv = document.getElementById('status');
          try {
              const q = query(leadsCollection, orderBy("createdAt", "desc"));
              const querySnapshot = await getDocs(q);
              
              loadedLeads = []; // Limpiamos la lista local
              querySnapshot.forEach((doc) => {
                  loadedLeads.push({ id: doc.id, ...doc.data() });
              });
              
              sortLeads(); // Ordenamos la lista según el criterio actual
              RenderLeads(); // Dibujamos los datos en la UI
              
              statusDiv.style.display = 'none';
          } catch (error) { console.error("Error al cargar: ", error); }
      }

      function RenderLeads() {
          const lang = localStorage.getItem('language') || 'es';
          cardViewContainer.innerHTML = '';
          listViewTbody.innerHTML = '';

          loadedLeads.forEach(lead => {
              // --- Renderizar Vista de Tarjeta ---
              const cardHTML = `
                  <div class="lead-card">
                      <h2>${lead.businessName || 'S/N'}</h2>
                      <p><strong>${translations[lang].contactHeader}:</strong> ${lead.dm?.firstName || ''} ${lead.dm?.lastName || ''}</p>
                      <p><strong>${translations[lang].phoneHeader}:</strong> ${lead.dm?.phone || 'N/A'}</p>
                      <p><strong>Email:</strong> ${lead.dm?.email || 'N/A'}</p>
                      <p><strong>${translations[lang].progressHeader}:</strong> <span class="status-tag ${getProgressClass(lead.leadProgress)}">${lead.leadProgress || 'N/A'}</span></p>
                      <div class="actions">
                        <button class="edit-btn" data-id="${lead.id}">${translations[lang].editBtn}</button>
                        <button class="delete-btn" data-id="${lead.id}">${translations[lang].deleteBtn}</button>
                      </div>
                  </div>`;
              cardViewContainer.innerHTML += cardHTML;

              // --- Renderizar Vista de Lista ---
              const entryDate = lead.createdAt?.toDate ? lead.createdAt.toDate().toLocaleDateString() : 'N/A';
              const listRowHTML = `
                  <tr>
                      <td>${lead.businessName || 'S/N'}</td>
                      <td>${entryDate}</td>
                      <td><span class="status-tag ${getProgressClass(lead.leadProgress)}">${lead.leadProgress || 'N/A'}</span></td>
                      <td>${lead.dm?.firstName || ''} ${lead.dm?.lastName || ''}</td>
                      <td>${lead.dm?.phone || 'N/A'}</td>
                      <td>
                        <button class="edit-btn" data-id="${lead.id}">${translations[lang].editBtn}</button>
                        <button class="delete-btn" data-id="${lead.id}">${translations[lang].deleteBtn}</button>
                      </td>
                  </tr>`;
              listViewTbody.innerHTML += listRowHTML;
          });
      }

      // Resto del código (formularios, editar, eliminar, etc.) permanece casi igual, 
      // asegurándose de llamar a CargarLeads() después de cada operación.

      // Carga inicial
      const initialLang = localStorage.getItem('language') || 'es';
      setLanguage(initialLang); // Esto ahora también llama a CargarLeads()
    </script>
</body>
</html>
